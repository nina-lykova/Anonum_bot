import telebot # –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Bot API. 
import threading #–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ç–æ–∫–∞–º–∏. –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
import queue #–ú–æ–¥—É–ª—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π. –û—á–µ—Ä–µ–¥–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏.
import logging #–ú–æ–¥—É–ª—å –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π/–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø–∏—Å–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–±–æ—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ —Ñ–∞–π–ª –∏–ª–∏ –¥—Ä—É–≥–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
from config import API_TOKEN
import time
from telebot import types

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(filename='bot.log', level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
"""–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:
‚Ä¢   logging.basicConfig(...): –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –±–∞–∑–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
‚Ä¢ filename='bot.log': –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ª–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ —Ñ–∞–π–ª bot.log.
‚Ä¢ level=logging.INFO: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è INFO.
        ‚Ä¢   logging.info("–°–æ–æ–±—â–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è")
        ‚Ä¢   logging.warning("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ")
        ‚Ä¢   logging.error("–û—à–∏–±–∫–∞")
        ‚Ä¢   logging.critical("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞")
‚Ä¢ format='%(asctime)s - %(levelname)s - %(message)s': –£–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –ª–æ–≥–∞:
        * %(asctime)s: –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞.
        * %(levelname)s: –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, INFO, WARNING, ERROR).
        * %(message)s: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ª–æ–≥–∞."""

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = telebot.TeleBot(API_TOKEN) 

# –û—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤
waiting_queue = queue.Queue()

#–∫–∏–¥–∞–µ–º –∂–∞–ª–æ–±—É –Ω–∞ —é–∑–µ—Ä–∞(–±—É–¥–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –≤—ã–±–æ—Ä —Ç–∏–ø–æ–≤ –∂–∞–ª–æ–± –¥–ª—è —é–∑–µ—Ä–∞ –≤ –≤–∏–¥–µ –∫–Ω–æ–ø–æ–∫)
@bot.message_handler(commands=['report'])
def handler_report(message):
    markup = types.InlineKeyboardMarkup()#–°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —Å–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π
    markup.add(types.InlineKeyboardButton('üì∞–†–µ–∫–ª–∞–º–∞', callback_data='report_spam'))
    markup.add(types.InlineKeyboardButton('üí∞–ü—Ä–æ–¥–∞–∂–∞', callback_data='report_sale'))
    markup.add(types.InlineKeyboardButton('üëä–ù–∞—Å–∏–ª–∏–µ', callback_data='report_violence'))
    markup.add(types.InlineKeyboardButton('ü§¨–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ', callback_data='report_insult'))
    markup.add(types.InlineKeyboardButton('ü§ë–ú–æ—à–µ–Ω–∏—á–µ—Å—Ç–≤–æ', callback_data='report_fraud'))
    bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã:", reply_markup=markup)
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç inline-–∫–Ω–æ–ø–æ–∫
@bot.callback_query_handler(func=lambda call: call.data.startswith('report_'))
def callback_query(call):
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –∂–∞–ª–æ–±—ã
    report_type = call.data[7:]  # –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –∂–∞–ª–æ–±—ã –∏–∑ callback_data
    bot.answer_callback_query(call.id, f"–ñ–∞–ª–æ–±–∞ –Ω–∞ {report_type} –ø—Ä–∏–Ω—è—Ç–∞!")


# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è user_id –∏ chat_id —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
user_pairs = {}
#–ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –¥–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—á–µ—Ä–µ–¥–∏
def check_queue():
    while True:
        try:
            if waiting_queue.qsize() >= 2:
                #–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è waiting_queue.get() –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ user_id –∏–∑ –æ—á–µ—Ä–µ–¥–∏.

                user_id1 = waiting_queue.get()  # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                user_id2 = waiting_queue.get()  # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                logging.info(f"–°–æ–µ–¥–∏–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π {user_id1} –∏ {user_id2}")

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–µ–∂–¥—É user_id –∏ chat_id —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                user_pairs[user_id1] = user_id2
                user_pairs[user_id2] = user_id1

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –æ–Ω–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω—ã
                bot.send_message(user_id1,"""–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω
/next -- –∏—Å–∫–∞—Ç—å –Ω–æ–≤–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                 
/stop -- –∑–∞–∫–æ–Ω—á–∏—Ç—å –¥–∏–∞–ª–æ–≥""")
                bot.send_message(user_id2,"""–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω
/next -- –∏—Å–∫–∞—Ç—å –Ω–æ–≤–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
                 
/stop -- –∑–∞–∫–æ–Ω—á–∏—Ç—å –¥–∏–∞–ª–æ–≥""")          
            time.sleep(1)  # –ü–∞—É–∑–∞ –≤ 1 —Å–µ–∫—É–Ω–¥—É, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä

        except Exception as e:
                    logging.error(f"–û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ check_queue: {e}")
                    time.sleep(10)  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–∞—É–∑—É –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏

#–ø—Ä–∏–≤–µ—Ç—Å–≤–∏–µ 
@bot.message_handler(commands=['start'])
#–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –æ–∂–∏–¥–∞–Ω–∏—è
def handler_start(message):
    bot.reply_to(message, "–ü—Ä–∏–≤–µ—Ç —Ç—ã –ø–æ–ø–∞–ª –≤ –∞–Ω–æ–Ω–∏–º–Ω—ã–π —á–∞—Ç, –≤ –Ω–µ–º –Ω–µ–ª—å–∑—è —Ä—É–≥–∞—Ç—å—Å—è, –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Ñ–æ—Ç–æ, –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —é–∑—ã(—Ç–æ–ª—å–∫–æ –ø–ª–∞—Ç–Ω–æ:) - —É–¥–∞—á–∏ –≤ –æ–±—â–µ–Ω–∏–∏!!!")
    user_id = message.chat.id
    logging.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—É—Å—Ç–∏–ª –∫–æ–º–∞–Ω–¥—É /start") #–ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω—Ñ–æ –≤ –ª–æ–≥
    waiting_queue.put(user_id) #–î–æ–±–∞–≤–ª—è–µ–º user_id –≤ –æ—á–µ—Ä–µ–¥—å
    bot.reply_to(message,"–í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å")


#—Å—Ç–æ–ø–∞–µ–º —é–∑–µ—Ä–∞ –∏ –¥–∞–µ–º –µ–º—É –≤—ã–±–æ—Ä –≤ –≤–∏–¥–µ: –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏–ª–∏ –∫–∏–¥–∞–Ω—É—Ç—å –Ω–∞ –Ω–µ–≥–æ –∂–∞–ª–æ–±—É(–∫–Ω–æ–ø–∫–∏)
@bot.message_handler(commands=['stop'])
def handler_stop(message):
    #–ü–æ–ª—É—á–µ–º —é–∑–µ—Ä_–∞–π–¥–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
    user_id = message.chat.id
    try:
        if user_id in user_pairs:#–ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω —Å–µ—Ç—å –≤ —Å–ª–æ–≤–∞—Ä–µ
            sobes_id = user_pairs[user_id]#–ü–æ–ª—É—á–∞–µ–º user_id —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏–∑ —Å–ª–æ–≤–∞—Ä—è
                #–°–æ–æ–±—â–∞–µ–º –æ–± —ç—Ç–æ–º —é–∑–µ—Ä–∞–º
            bot.send_message(user_id, """–í—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏ —Å–≤—è–∑—å —Å –≤–∞—à–∏–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–ºüôÑ
                             
–ù–∞–ø–∏—à–∏ /search —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ, –µ—Å–ª–∏ —Ç–µ–±–µ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–ø–∏—à–∏ /report –∏ –∫–∏–¥–∞–Ω–∏ –Ω–∞ –Ω–µ–≥–æ –∂–∞–ª–æ–±—É
                             
–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –æ—Å—Ç–∞–≤—å—Ç–µ –º–Ω–µ–Ω–∏–µ –æ –≤–∞—à–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –≤–∞–º –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤""")

            bot.send_message(sobes_id, """–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª —á–∞—Çüò≠
                           
–ù–∞–ø–∏—à–∏ /search —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ, –µ—Å–ª–∏ —Ç–µ–±–µ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–ø–∏—à–∏ /report –∏ –∫–∏–¥–∞–Ω–∏ –Ω–∞ –Ω–µ–≥–æ –∂–∞–ª–æ–±—É
                             
–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –æ—Å—Ç–∞–≤—å—Ç–µ –º–Ω–µ–Ω–∏–µ –æ –≤–∞—à–µ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –≤–∞–º –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤""")

                #—É–¥–∞–ª—è–µ–º —é–∑–µ—Äa
            del user_pairs[user_id]
            del user_pairs[sobes_id]
        else:
            bot.send_message(user_id, "–í—ã –Ω–µ —Å–æ–µ–¥–∏–Ω–µ–Ω—ã –Ω–∏ —Å –∫–µ–º:(")
    except Exception as e:
        logging.exception("–û—à–∏–±–∫–∞ –≤ handle_stop")

#–Ω–µ–∫—Å—Ç —é–∑–µ—Ä
@bot.message_handler(commands=['next'])
def handler_next(message):
    user_id = message.chat.id
    if user_id in user_pairs:
        sobes_id = user_pairs[user_id]

        del user_pairs[user_id]
        del user_pairs[sobes_id]

        waiting_queue.put(user_id) #–î–æ–±–∞–≤–ª—è–µ–º user_id –≤ –æ—á–µ—Ä–µ–¥—å
        
        bot.send_message(user_id, "–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —á–∞—Ç –∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å –æ–∂–∏–¥–∞–Ω–∏—è")
        bot.send_message(sobes_id, '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª —á–∞—Ç, —Ö–æ—Ç–∏—Ç–µ –Ω–∞–π—Ç–∏ –Ω–æ–≤–æ–≥–æ? –ù–∞–ø–∏—à–∏—Ç–µ /search')

#–ò—â–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —é–∑–µ—Ä–∞
@bot.message_handler(commands=['search'])
def handler_search(message):
    user_id = message.chat.id
    waiting_queue.put(user_id) #–î–æ–±–∞–≤–ª—è–µ–º user_id –≤ –æ—á–µ—Ä–µ–¥—å
    bot.send_message(user_id, '–ò—â–µ–º –¥–ª—è –≤–∞—Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞!')
    check_queue()

# –ø–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ
@bot.message_handler(func=lambda message: True)
def handle_all_messages(message):
    #–ü–æ–ª—É—á–µ–º —é–∑–µ—Ä_–∞–π–¥–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
    user_id = message.chat.id
    if user_id in user_pairs:#–ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–Ω —Å–µ—Ç—å –≤ —Å–ª–æ–≤–∞—Ä–µ
        user_id = user_pairs[user_id]#–ü–æ–ª—É—á–∞–µ–º user_id —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏–∑ —Å–ª–æ–≤–∞—Ä—è 
        # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–æ—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É
        bot.send_message(user_id, message.text)


if __name__ == '__main__':
    threading.Thread(target=check_queue, daemon=True).start()
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    bot.infinity_polling()
